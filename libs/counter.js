const a2_0x1381db=a2_0x5a56;(function(_0x1c5b4c,_0x15feea){const _0x172df4=a2_0x5a56,_0x5333aa=_0x1c5b4c();while(!![]){try{const _0x1726f4=-parseInt(_0x172df4(0x1e9))/0x1+-parseInt(_0x172df4(0x1f2))/0x2*(-parseInt(_0x172df4(0x1d7))/0x3)+-parseInt(_0x172df4(0x1dc))/0x4+-parseInt(_0x172df4(0x1f1))/0x5+parseInt(_0x172df4(0x1f8))/0x6*(-parseInt(_0x172df4(0x1dd))/0x7)+parseInt(_0x172df4(0x1f3))/0x8+parseInt(_0x172df4(0x1ce))/0x9;if(_0x1726f4===_0x15feea)break;else _0x5333aa['push'](_0x5333aa['shift']());}catch(_0x1827ec){_0x5333aa['push'](_0x5333aa['shift']());}}}(a2_0x55e9,0x6c725));function a2_0x5a56(_0x37b6e8,_0x1508d9){const _0x55e955=a2_0x55e9();return a2_0x5a56=function(_0x5a5655,_0x23458d){_0x5a5655=_0x5a5655-0x1b8;let _0x2dcc58=_0x55e955[_0x5a5655];return _0x2dcc58;},a2_0x5a56(_0x37b6e8,_0x1508d9);}const fs=require('fs')[a2_0x1381db(0x1c7)],osu=require(a2_0x1381db(0x1e6));class RequestMonitor{static [a2_0x1381db(0x1d6)]='cadviewer/settings/requests-per-minute.json';static [a2_0x1381db(0x1e3)]=a2_0x1381db(0x1ec);static [a2_0x1381db(0x1c8)]='cadviewer/settings/ressources-usage-stats.json';static ['rpsData']=[];static ['httpCodesData']=[];static [a2_0x1381db(0x1ba)]={};static [a2_0x1381db(0x1c1)]=Math['floor'](Date[a2_0x1381db(0x1db)]()/0x3e8/0x3c);static [a2_0x1381db(0x1e4)]=0x0;static async[a2_0x1381db(0x1d3)](){const _0x1cc0df=a2_0x1381db;console[_0x1cc0df(0x1b8)](_0x1cc0df(0x1fa));try{const _0x225778=await fs['readFile'](RequestMonitor[_0x1cc0df(0x1d6)],_0x1cc0df(0x1f5));RequestMonitor['rpsData']=JSON['parse'](_0x225778);}catch(_0x39f58a){RequestMonitor[_0x1cc0df(0x1f4)]=[];}try{const _0x3b72a4=await fs[_0x1cc0df(0x1cf)](RequestMonitor[_0x1cc0df(0x1e3)],_0x1cc0df(0x1f5));RequestMonitor['httpCodesData']=JSON['parse'](_0x3b72a4);}catch(_0xf0a853){RequestMonitor[_0x1cc0df(0x1f9)]=[];}try{const _0x264bb8=await fs['readFile'](RequestMonitor[_0x1cc0df(0x1c8)],_0x1cc0df(0x1f5));RequestMonitor[_0x1cc0df(0x1ba)]=JSON[_0x1cc0df(0x1d1)](_0x264bb8),!RequestMonitor[_0x1cc0df(0x1ba)][_0x1cc0df(0x1d8)]&&(RequestMonitor[_0x1cc0df(0x1ba)][_0x1cc0df(0x1d8)]=[]),!RequestMonitor[_0x1cc0df(0x1ba)][_0x1cc0df(0x1da)]&&(RequestMonitor[_0x1cc0df(0x1ba)][_0x1cc0df(0x1da)]=[]),!RequestMonitor[_0x1cc0df(0x1ba)]['network']&&(RequestMonitor[_0x1cc0df(0x1ba)]['network']=[]);}catch(_0x22334c){RequestMonitor[_0x1cc0df(0x1ba)]={'cpu':[],'memory':[],'network':[]};}console['log'](_0x1cc0df(0x1f7));}static['middleware'](_0x4d7ae3,_0x2b1dcf,_0x2ded67){const _0x55e170=a2_0x1381db;if(_0x4d7ae3['path'][_0x55e170(0x1c0)]('/metrics'))return _0x2ded67();console['log'](_0x55e170(0x1c3));let _0x2ef0a8=Date[_0x55e170(0x1db)](),_0x4ef37d=Math[_0x55e170(0x1b9)](_0x2ef0a8/0x3e8/0x3c);console[_0x55e170(0x1b8)]('=======>');const _0x37e861=_0x2b1dcf[_0x55e170(0x1e5)];_0x2b1dcf[_0x55e170(0x1e5)]=(..._0x55e51f)=>{const _0x33aa0f=_0x55e170;console[_0x33aa0f(0x1b8)](_0x4ef37d,{'currentMinute':_0x4ef37d});_0x4ef37d>RequestMonitor[_0x33aa0f(0x1c1)]&&(RequestMonitor['rpsData'][_0x33aa0f(0x1cc)]({'timestamp':RequestMonitor[_0x33aa0f(0x1c1)]*0x3e8*0x3c,'requests':RequestMonitor[_0x33aa0f(0x1e4)]}),RequestMonitor[_0x33aa0f(0x1e4)]=0x0,RequestMonitor['lastMinute']=_0x4ef37d);RequestMonitor[_0x33aa0f(0x1e4)]++,RequestMonitor[_0x33aa0f(0x1f9)]['push']({'timestamp':Date['now'](),'statusCode':_0x2b1dcf[_0x33aa0f(0x1c5)],'path':_0x4d7ae3[_0x33aa0f(0x1c6)],'method':_0x4d7ae3['method']});const _0x442088=Date[_0x33aa0f(0x1db)]()-0x18*0x3c*0x3c*0x3e8;return RequestMonitor['httpCodesData']=RequestMonitor['httpCodesData']['filter'](_0x28dd98=>_0x28dd98[_0x33aa0f(0x1bb)]>_0x442088),_0x37e861[_0x33aa0f(0x1eb)](_0x2b1dcf,_0x55e51f);},_0x2ded67();}static async[a2_0x1381db(0x1bc)](){const _0x53459e=a2_0x1381db;try{RequestMonitor[_0x53459e(0x1c1)]!==Math[_0x53459e(0x1b9)](Date[_0x53459e(0x1db)]()/0x3e8/0x3c)&&(RequestMonitor[_0x53459e(0x1f4)][_0x53459e(0x1cc)]({'timestamp':RequestMonitor['lastMinute']*0x3e8*0x3c,'requests':RequestMonitor['currentRequests']}),RequestMonitor[_0x53459e(0x1e4)]=0x0,RequestMonitor[_0x53459e(0x1c1)]=Math[_0x53459e(0x1b9)](Date[_0x53459e(0x1db)]()/0x3e8/0x3c)),await fs[_0x53459e(0x1c9)](RequestMonitor['rpsStoragePath'],JSON[_0x53459e(0x1c2)](RequestMonitor['rpsData'],null,0x2)),await fs[_0x53459e(0x1c9)](RequestMonitor[_0x53459e(0x1e3)],JSON['stringify'](RequestMonitor[_0x53459e(0x1f9)],null,0x2));}catch(_0x2f3ef3){console[_0x53459e(0x1fb)](_0x53459e(0x1e2),_0x2f3ef3);}}static async['startPeriodicSave'](){const _0x157ca8=a2_0x1381db;setInterval(()=>RequestMonitor[_0x157ca8(0x1bc)](),0x3c*0x3e8),setInterval(()=>{const _0x492258=_0x157ca8;RequestMonitor['getUsageRessourcesStatsAndSave']()[_0x492258(0x1f6)](()=>{});},0x3c*0x3e8),RequestMonitor[_0x157ca8(0x1ed)]()[_0x157ca8(0x1f6)](()=>{});}static async[a2_0x1381db(0x1ed)](){const _0x50c77e=a2_0x1381db,_0x3b1cf9=osu[_0x50c77e(0x1d8)],_0x3d63a8=osu[_0x50c77e(0x1be)],_0x79268f=osu['netstat'],_0xb78717={'total':{'inputMb':0x0,'outputMb':0x0}};try{const _0x3d1cce=await _0x79268f[_0x50c77e(0x1f0)]();_0xb78717['total'][_0x50c77e(0x1ca)]=_0x3d1cce[_0x50c77e(0x1d5)][_0x50c77e(0x1ca)],_0xb78717[_0x50c77e(0x1d5)][_0x50c77e(0x1e1)]=_0x3d1cce[_0x50c77e(0x1d5)][_0x50c77e(0x1e1)];}catch(_0x4bb040){}let _0x8f1803=0x0;try{_0x8f1803=await _0x3b1cf9['usage']();}catch(_0xd078a1){console[_0x50c77e(0x1b8)](_0x50c77e(0x1d2),_0xd078a1);}const _0x4222fb={'usedMemMb':0x0};try{const _0x19ea39=await _0x3d63a8['info']();_0x4222fb['usedMemMb']=_0x19ea39[_0x50c77e(0x1de)];}catch(_0x58eed2){console[_0x50c77e(0x1b8)]('Error\x20getting\x20memory\x20usage:',_0x58eed2);}const _0x2efe4d=new Date()[_0x50c77e(0x1bf)]()['toString']()[_0x50c77e(0x1e0)](0x2,'0')+':'+new Date()[_0x50c77e(0x1d0)]()[_0x50c77e(0x1c4)]()[_0x50c77e(0x1e0)](0x2,'0');RequestMonitor['ressourcesUsageStats']['cpu']=RequestMonitor[_0x50c77e(0x1ba)][_0x50c77e(0x1d8)][_0x50c77e(0x1d9)](-0x3c)[_0x50c77e(0x1e7)](_0x39adf5=>_0x39adf5[_0x50c77e(0x1bd)]!==_0x2efe4d),RequestMonitor[_0x50c77e(0x1ba)]['memory']=RequestMonitor[_0x50c77e(0x1ba)]['memory'][_0x50c77e(0x1d9)](-0x3c)[_0x50c77e(0x1e7)](_0xaabbcd=>_0xaabbcd[_0x50c77e(0x1bd)]!==_0x2efe4d),RequestMonitor[_0x50c77e(0x1ba)][_0x50c77e(0x1ea)]=RequestMonitor[_0x50c77e(0x1ba)][_0x50c77e(0x1ea)][_0x50c77e(0x1d9)](-0x3c)[_0x50c77e(0x1e7)](_0x6f3818=>_0x6f3818['time']!==_0x2efe4d),RequestMonitor[_0x50c77e(0x1ba)][_0x50c77e(0x1d8)][_0x50c77e(0x1cc)]({'time':_0x2efe4d,'usage':_0x8f1803}),RequestMonitor[_0x50c77e(0x1ba)][_0x50c77e(0x1da)]['push']({'time':_0x2efe4d,'usage':(_0x4222fb['usedMemMb']/0x3e8)[_0x50c77e(0x1cd)](0x2)}),RequestMonitor['ressourcesUsageStats'][_0x50c77e(0x1ea)][_0x50c77e(0x1cc)]({'time':_0x2efe4d,'usage':{'in':_0xb78717[_0x50c77e(0x1d5)]?.[_0x50c77e(0x1ca)]??0x0,'out':_0xb78717[_0x50c77e(0x1d5)]?.['outputMb']??0x0}});try{await fs[_0x50c77e(0x1c9)](RequestMonitor[_0x50c77e(0x1c8)],JSON[_0x50c77e(0x1c2)](RequestMonitor[_0x50c77e(0x1ba)],null,0x2));}catch(_0x5d7f3a){console['error'](_0x50c77e(0x1e2),_0x5d7f3a);}}static['getStats'](){const _0x204e67=a2_0x1381db,_0x501a92=Date[_0x204e67(0x1db)](),_0x23eb8c=_0x501a92-0x3c*0x3c*0x3e8,_0x1b3812=_0x501a92-0x18*0x3c*0x3c*0x3e8,_0x3e2a35=RequestMonitor[_0x204e67(0x1f4)][_0x204e67(0x1e7)](_0x353288=>_0x353288[_0x204e67(0x1bb)]>_0x23eb8c),_0x3bcdc0={'total':RequestMonitor[_0x204e67(0x1f9)][_0x204e67(0x1e8)],'byCodes':{},'byPath':{}};return RequestMonitor[_0x204e67(0x1f9)][_0x204e67(0x1ef)](_0x4af3f6=>{const _0x17dce0=_0x204e67;_0x3bcdc0['byCodes'][_0x4af3f6[_0x17dce0(0x1c5)]]=(_0x3bcdc0['byCodes'][_0x4af3f6[_0x17dce0(0x1c5)]]||0x0)+0x1;const _0x362d12=_0x4af3f6[_0x17dce0(0x1cb)]+'\x20'+_0x4af3f6[_0x17dce0(0x1c6)];!_0x3bcdc0['byPath'][_0x362d12]&&(_0x3bcdc0[_0x17dce0(0x1df)][_0x362d12]={'total':0x0,'codes':{}}),_0x3bcdc0[_0x17dce0(0x1df)][_0x362d12][_0x17dce0(0x1d5)]++,_0x3bcdc0[_0x17dce0(0x1df)][_0x362d12][_0x17dce0(0x1ee)][_0x4af3f6[_0x17dce0(0x1c5)]]=(_0x3bcdc0[_0x17dce0(0x1df)][_0x362d12][_0x17dce0(0x1ee)][_0x4af3f6[_0x17dce0(0x1c5)]]||0x0)+0x1;}),{'rps':_0x3e2a35,'httpCodes':_0x3bcdc0,'ressourcesUsageStats':RequestMonitor[_0x204e67(0x1ba)]};}}RequestMonitor[a2_0x1381db(0x1d3)]()[a2_0x1381db(0x1f6)](()=>{}),RequestMonitor[a2_0x1381db(0x1d4)]();const counter=RequestMonitor;function a2_0x55e9(){const _0x1ca1ab=['4498616KwDvRl','rpsData','utf8','then','Request\x20monitor\x20initialized.','69684AZzJLz','httpCodesData','Initializing\x20request\x20monitor...','error','log','floor','ressourcesUsageStats','timestamp','save','time','mem','getHours','includes','lastMinute','stringify','Request\x20monitor\x20middleware','toString','statusCode','path','promises','ressourcesUsageStatsPath','writeFile','inputMb','method','push','toFixed','14318685mRXeRg','readFile','getMinutes','parse','Error\x20getting\x20CPU\x20usage:','init','startPeriodicSave','total','rpsStoragePath','9JBPhEv','cpu','slice','memory','now','3401260JnqyNU','448xqtFpm','usedMemMb','byPath','padStart','outputMb','Error\x20saving\x20monitoring\x20data:','httpCodesStoragePath','currentRequests','end','node-os-utils','filter','length','285141antOHR','network','apply','cadviewer/settings/http-codes-24h.json','getUsageRessourcesStatsAndSave','codes','forEach','inOut','80950ulBsTJ','123898IEbhaM'];a2_0x55e9=function(){return _0x1ca1ab;};return a2_0x55e9();}module['exports']=counter;