const a1_0x215c3c=a1_0x4571;(function(_0x343de6,_0x14d677){const _0xfc55de=a1_0x4571,_0x462742=_0x343de6();while(!![]){try{const _0x35d2ad=parseInt(_0xfc55de(0x15a))/0x1+parseInt(_0xfc55de(0x144))/0x2*(-parseInt(_0xfc55de(0x150))/0x3)+-parseInt(_0xfc55de(0x132))/0x4+parseInt(_0xfc55de(0x171))/0x5*(parseInt(_0xfc55de(0x14e))/0x6)+-parseInt(_0xfc55de(0x141))/0x7+parseInt(_0xfc55de(0x160))/0x8*(parseInt(_0xfc55de(0x120))/0x9)+parseInt(_0xfc55de(0x130))/0xa*(parseInt(_0xfc55de(0x162))/0xb);if(_0x35d2ad===_0x14d677)break;else _0x462742['push'](_0x462742['shift']());}catch(_0x2aff0c){_0x462742['push'](_0x462742['shift']());}}}(a1_0x1c39,0xabd1c));const jwt=require(a1_0x215c3c(0x168)),bcrypt=require(a1_0x215c3c(0x16b)),config=require(a1_0x215c3c(0x12a)),conn=require(a1_0x215c3c(0x15f)),multer=require(a1_0x215c3c(0x12f)),fs=require('fs'),verifyToken=require('../libs/jwt')['verifyToken'],{sendWelcomeEmail}=require(a1_0x215c3c(0x128)),axios=require(a1_0x215c3c(0x15d));function a1_0x1c39(){const _0x41de5a=['24h','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','bcrypt','Error\x20during\x20reCAPTCHA\x20verification.','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','body','status','single','6895540jaWpeE','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','Error\x20during\x20user\x20creation:','./uploads/','reCAPTCHA\x20verification\x20error:','ServerUrl','log','callbackMethod_gatewayUrl_flag','.png','Invalid\x20email\x20or\x20password','username','exports','/login','Error\x20parsing\x20geolocation\x20data:','514611etCPoD','crypted_password','express','json','===================error===================','hash','./avatars','sign','../libs/email-utils','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','../CADViewer_config.json','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','length','languages','copyFileSync','multer','46700GDiCxf','role','2752384MhfbxG','stack','recaptchaSecretKey','execute','params','last_name','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?','recaptchaEnabled','Invalid\x20user','time_zone','enableEmailVerification','message','compare','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?','avatar_url','9613751LHLnEW','first_name','is_enabled','86RgJgex','name','error-codes','unlinkSync','User\x20already\x20exists','country_name','diskStorage','/validate-email/:token','email','insertId','6JOcevN','success','53145mFenTl','avatars/','https://www.google.com/recaptcha/api/siteverify','/update-password','post','/update-user-info','user','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','callbackMethod_gatewayUrl','file','38767HFRadL','path','promise','axios','avatar','../libs/mysql.js','152MmxZja','avatars','2409txEIic','Invalid\x20password','Error!\x20Something\x20went\x20wrong.','error','jwtSecretKey','demo_user','jsonwebtoken'];a1_0x1c39=function(){return _0x41de5a;};return a1_0x1c39();}function a1_0x4571(_0x45bab7,_0x261b55){const _0x1c3974=a1_0x1c39();return a1_0x4571=function(_0x4571d8,_0x4d63f8){_0x4571d8=_0x4571d8-0x116;let _0x766ab2=_0x1c3974[_0x4571d8];return _0x766ab2;},a1_0x4571(_0x45bab7,_0x261b55);}!fs['existsSync']('./avatars')&&fs['mkdirSync'](a1_0x215c3c(0x126));const express=require(a1_0x215c3c(0x122)),router=express['Router'](),{randomUUID}=require('crypto'),storage=multer[a1_0x215c3c(0x14a)]({'destination':function(_0x53afab,_0x10c219,_0x184112){const _0x5892c7=a1_0x215c3c;_0x184112(null,_0x5892c7(0x161));}}),upload=multer({'storage':storage});router[a1_0x215c3c(0x154)](a1_0x215c3c(0x11e),async(_0x2c8852,_0x4db0a7,_0x2de551)=>{const _0x3a6bf0=a1_0x215c3c;let {email:_0x527667,password:_0x237e9b}=_0x2c8852['body'];console[_0x3a6bf0(0x118)]({'email':_0x527667,'password':_0x237e9b});let _0x314a93;try{const [_0x3ce87d]=await conn['promise']()[_0x3a6bf0(0x135)](_0x3a6bf0(0x13f),[_0x527667]);_0x3ce87d[_0x3a6bf0(0x12c)]>0x0&&(_0x314a93=_0x3ce87d[0x0]);}catch(_0x4223f3){console[_0x3a6bf0(0x118)]({'err':_0x4223f3}),_0x4db0a7[_0x3a6bf0(0x16f)](0x1f4)[_0x3a6bf0(0x123)]({'error':_0x3a6bf0(0x164)});return;}if(!_0x314a93||!await bcrypt['compare'](_0x237e9b,_0x314a93?.[_0x3a6bf0(0x121)])){_0x4db0a7[_0x3a6bf0(0x16f)](0x191)[_0x3a6bf0(0x123)]({'error':_0x3a6bf0(0x11b)});return;}let _0x32d6e0;try{_0x32d6e0=jwt[_0x3a6bf0(0x127)]({'userId':_0x314a93['id'],'email':_0x314a93[_0x3a6bf0(0x14c)]},config['jwtSecretKey'],{'expiresIn':_0x3a6bf0(0x169)});}catch(_0x17f518){console[_0x3a6bf0(0x118)](_0x17f518),_0x4db0a7[_0x3a6bf0(0x16f)](0x1f4)[_0x3a6bf0(0x123)]({'error':_0x3a6bf0(0x164)});return;}_0x4db0a7[_0x3a6bf0(0x16f)](0xc8)['json']({'success':!![],'data':{'userId':_0x314a93['id'],'username':_0x314a93[_0x3a6bf0(0x11c)],'first_name':_0x314a93[_0x3a6bf0(0x142)],'last_name':_0x314a93[_0x3a6bf0(0x137)],'email':_0x314a93[_0x3a6bf0(0x14c)],'avatar_url':_0x314a93[_0x3a6bf0(0x140)],'id':_0x314a93['id'],'role':_0x314a93['role'],'token':_0x32d6e0}});}),router[a1_0x215c3c(0x154)]('/signup',async(_0x529db4,_0x3ecc04,_0x3c9477)=>{const _0x12683c=a1_0x215c3c,{username:_0xab6e05,email:_0x4dc749,password:_0x52635b,geolocation:_0x46e222,recaptchaToken:_0x2a2983}=_0x529db4['body'];if(config[_0x12683c(0x139)]){if(!_0x2a2983)return _0x3ecc04[_0x12683c(0x16f)](0x190)[_0x12683c(0x123)]({'error':_0x12683c(0x157)});try{const _0x37abe1=await axios[_0x12683c(0x154)](_0x12683c(0x152),null,{'params':{'secret':config[_0x12683c(0x134)],'response':_0x2a2983}});if(!_0x37abe1['data'][_0x12683c(0x14f)])return _0x3ecc04['status'](0x190)[_0x12683c(0x123)]({'error':_0x12683c(0x157),'recaptchaErrors':_0x37abe1['data'][_0x12683c(0x146)]});}catch(_0x33e432){return console[_0x12683c(0x165)](_0x12683c(0x116),_0x33e432),_0x3ecc04[_0x12683c(0x16f)](0x1f4)[_0x12683c(0x123)]({'error':_0x12683c(0x16c)});}}const [_0x3d620d]=await conn['promise']()[_0x12683c(0x135)](_0x12683c(0x16d),[_0x4dc749]);if(_0x3d620d[_0x12683c(0x12c)]>0x0){_0x3ecc04[_0x12683c(0x16f)](0x1a6)[_0x12683c(0x123)]({'error':_0x12683c(0x148)});return;}const _0x144d6c=await bcrypt[_0x12683c(0x125)](_0x52635b,0xa);let _0x4b9718=null,_0x3c662a=0x1;config[_0x12683c(0x13c)]&&(_0x4b9718=randomUUID(),_0x3c662a=0x0);let _0x5b6aac=null,_0x33e5bf=null,_0x2e20cf=null,_0x50d6b2=null,_0x4b5c4e=null,_0x3aa044=null;if(_0x46e222)try{const _0x3f5dc0=_0x46e222;_0x5b6aac=_0x3f5dc0['city']||null,_0x33e5bf=_0x3f5dc0['region']||null,_0x2e20cf=_0x3f5dc0[_0x12683c(0x149)]||null,_0x3f5dc0[_0x12683c(0x12d)]&&_0x3f5dc0[_0x12683c(0x12d)][_0x12683c(0x12c)]>0x0&&(_0x50d6b2=_0x3f5dc0['languages'][0x0]['code']||null,_0x4b5c4e=_0x3f5dc0[_0x12683c(0x12d)][0x0]['name']||null),_0x3f5dc0['time_zone']&&(_0x3aa044=_0x3f5dc0[_0x12683c(0x13b)][_0x12683c(0x145)]||null);}catch(_0x1e5fe1){console[_0x12683c(0x118)](_0x12683c(0x11f),_0x1e5fe1);}let _0x275049;try{const _0xc29661=randomUUID(),_0x43eef3=_0x12683c(0x174)+_0xc29661;fs['mkdirSync'](_0x43eef3);const [_0x1bd1e5]=await conn[_0x12683c(0x15c)]()[_0x12683c(0x135)](_0x12683c(0x129),[_0xab6e05,_0x4dc749,_0x144d6c,_0x12683c(0x167),_0x3c662a,_0x4b9718,_0xc29661,_0x5b6aac,_0x33e5bf,_0x2e20cf,_0x50d6b2,_0x4b5c4e,_0x3aa044]);if(_0x1bd1e5[_0x12683c(0x14d)]){const [_0x57a8ff]=await conn[_0x12683c(0x15c)]()['execute'](_0x12683c(0x138),[_0x1bd1e5[_0x12683c(0x14d)]]);_0x57a8ff[_0x12683c(0x12c)]>0x0&&(_0x275049=_0x57a8ff[0x0]);}}catch(_0x444b3e){console['log'](_0x12683c(0x173),_0x444b3e),_0x3ecc04['status'](0x1f4)[_0x12683c(0x123)]({'error':_0x12683c(0x164)});return;}let _0x4ea3f6;try{_0x4ea3f6=jwt[_0x12683c(0x127)]({'userId':_0x275049['id'],'email':_0x275049[_0x12683c(0x14c)]},config[_0x12683c(0x166)],{'expiresIn':'24h'});}catch(_0x3ebfd7){_0x3ecc04['status'](0x1f4)[_0x12683c(0x123)]({'error':_0x12683c(0x164)});return;}if(config[_0x12683c(0x13c)]){try{await sendWelcomeEmail(_0x275049,_0x4b9718);}catch(_0x598e75){console[_0x12683c(0x118)](_0x12683c(0x124)),console[_0x12683c(0x118)](_0x598e75);}_0x3ecc04[_0x12683c(0x16f)](0xc8)[_0x12683c(0x123)]({'success':!![],'message':'Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.'});return;}_0x3ecc04[_0x12683c(0x16f)](0xc9)[_0x12683c(0x123)]({'success':!![],'data':{'userId':_0x275049['id'],'username':_0x275049[_0x12683c(0x11c)],'first_name':_0x275049[_0x12683c(0x142)],'last_name':_0x275049[_0x12683c(0x137)],'email':_0x275049[_0x12683c(0x14c)],'avatar_url':_0x275049[_0x12683c(0x140)],'id':_0x275049['id'],'role':_0x275049[_0x12683c(0x131)],'token':_0x4ea3f6,'is_enabled':_0x275049[_0x12683c(0x143)]}});}),router[a1_0x215c3c(0x154)](a1_0x215c3c(0x14b),async(_0x58a399,_0x46f100)=>{const _0x5f2c57=a1_0x215c3c;try{const {token:_0x308bc6}=_0x58a399[_0x5f2c57(0x136)],[_0x919247]=await conn[_0x5f2c57(0x15c)]()[_0x5f2c57(0x135)](_0x5f2c57(0x12b),[_0x308bc6]);if(_0x919247[_0x5f2c57(0x12c)]===0x0){_0x46f100[_0x5f2c57(0x16f)](0x194)[_0x5f2c57(0x123)]({'error':'Invalid\x20validation\x20token'});return;}await conn[_0x5f2c57(0x15c)]()[_0x5f2c57(0x135)]('UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?',[_0x308bc6]);const _0x15c020=jwt[_0x5f2c57(0x127)]({'id':_0x919247[0x0]['id'],'email':_0x919247[0x0][_0x5f2c57(0x14c)]},config[_0x5f2c57(0x166)],{'expiresIn':_0x5f2c57(0x169)});_0x46f100['status'](0xc8)[_0x5f2c57(0x123)]({'success':!![],'message':'Email\x20validated\x20successfully','data':{'userId':_0x919247[0x0]['id'],'username':_0x919247[0x0][_0x5f2c57(0x11c)],'first_name':_0x919247[0x0][_0x5f2c57(0x142)],'last_name':_0x919247[0x0][_0x5f2c57(0x137)],'email':_0x919247[0x0][_0x5f2c57(0x14c)],'avatar_url':_0x919247[0x0][_0x5f2c57(0x140)],'id':_0x919247[0x0]['id'],'role':_0x919247[0x0][_0x5f2c57(0x131)],'token':_0x15c020,'is_enabled':0x1}});}catch(_0x47c11d){console[_0x5f2c57(0x118)]('===================error==================='),console[_0x5f2c57(0x118)](_0x47c11d),_0x46f100[_0x5f2c57(0x16f)](0x1f4)[_0x5f2c57(0x123)]({'error':_0x5f2c57(0x164),'stack':_0x47c11d[_0x5f2c57(0x133)],'message':_0x47c11d[_0x5f2c57(0x13d)]});}}),router[a1_0x215c3c(0x154)](a1_0x215c3c(0x153),verifyToken,async(_0x20650e,_0x89c0f0,_0x12ac4b)=>{const _0x50b836=a1_0x215c3c,{current_password:_0x57b40e,new_password:_0xa85201}=_0x20650e[_0x50b836(0x16e)];console[_0x50b836(0x118)]({'body':_0x20650e[_0x50b836(0x16e)]});const _0x230d3e=_0x20650e[_0x50b836(0x156)][_0x50b836(0x14c)];let _0x3679b0;try{const [_0x40bffe]=await conn[_0x50b836(0x15c)]()[_0x50b836(0x135)](_0x50b836(0x16d),[_0x230d3e]);if(_0x40bffe['length']>0x0){_0x3679b0=_0x40bffe[0x0];if(!await bcrypt[_0x50b836(0x13e)](_0x57b40e,_0x3679b0[_0x50b836(0x121)])){_0x89c0f0[_0x50b836(0x16f)](0x191)['json']({'error':_0x50b836(0x163)});return;}const _0x298e7a=await bcrypt[_0x50b836(0x125)](_0xa85201,0xa);await conn[_0x50b836(0x15c)]()[_0x50b836(0x135)](_0x50b836(0x172),[_0x298e7a,_0x230d3e]),_0x89c0f0['status'](0xc8)[_0x50b836(0x123)]({'success':!![]});}}catch(_0x2bb68f){console[_0x50b836(0x118)]({'err':_0x2bb68f}),_0x89c0f0['status'](0x1f4)[_0x50b836(0x123)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x215c3c(0x154)](a1_0x215c3c(0x155),upload[a1_0x215c3c(0x170)](a1_0x215c3c(0x15e)),verifyToken,async(_0x491a63,_0x2bca4d,_0x1cedac)=>{const _0x297269=a1_0x215c3c,{username:_0x446e4f,first_name:_0x1b2957,last_name:_0x33e9a8}=_0x491a63['body'],_0x43d873=_0x491a63[_0x297269(0x156)][_0x297269(0x14c)];let _0x56288;try{const [_0x4fabb5]=await conn[_0x297269(0x15c)]()['execute'](_0x297269(0x16d),[_0x43d873]);_0x4fabb5[_0x297269(0x12c)]>0x0&&(_0x56288=_0x4fabb5[0x0]);}catch(_0xaae394){console[_0x297269(0x118)]({'err':_0xaae394}),_0x2bca4d[_0x297269(0x16f)](0x1f4)['json']({'error':_0x297269(0x164)});return;}if(!_0x56288){_0x2bca4d[_0x297269(0x16f)](0x191)[_0x297269(0x123)]({'error':_0x297269(0x13a)});return;}console['log']({'req':_0x491a63[_0x297269(0x16e)]});let _0x584b97=_0x56288[_0x297269(0x140)];if(_0x491a63[_0x297269(0x159)]){const _0x4abd94=_0x297269(0x151)+randomUUID()+_0x297269(0x11a);fs[_0x297269(0x12e)](_0x491a63[_0x297269(0x159)]['path'],'./'+_0x4abd94),fs[_0x297269(0x147)](_0x491a63[_0x297269(0x159)][_0x297269(0x15b)]),config[_0x297269(0x119)]?_0x584b97=config[_0x297269(0x158)]+'/'+_0x4abd94:_0x584b97=config[_0x297269(0x117)]+'/'+_0x4abd94;}try{await conn[_0x297269(0x15c)]()['execute'](_0x297269(0x16a),[_0x446e4f,_0x1b2957,_0x33e9a8,_0x584b97,_0x43d873]);let _0x23f9ad;try{_0x23f9ad=jwt[_0x297269(0x127)]({'userId':_0x56288['id'],'email':_0x56288[_0x297269(0x14c)]},config[_0x297269(0x166)],{'expiresIn':_0x297269(0x169)});}catch(_0x17378e){console['log'](_0x17378e),_0x2bca4d[_0x297269(0x16f)](0x1f4)['json']({'error':_0x297269(0x164)});return;}_0x2bca4d[_0x297269(0x16f)](0xc8)[_0x297269(0x123)]({'success':!![],'data':{'userId':_0x56288['id'],'username':_0x446e4f,'first_name':_0x1b2957,'last_name':_0x33e9a8,'email':_0x56288[_0x297269(0x14c)],'avatar_url':_0x584b97,'token':_0x23f9ad}});}catch(_0x3a1ac0){console[_0x297269(0x118)]({'err':_0x3a1ac0}),_0x2bca4d['status'](0x1f4)[_0x297269(0x123)]({'error':_0x297269(0x164)});return;}}),module[a1_0x215c3c(0x11d)]=router;