const a1_0x4891d9=a1_0x5f17;function a1_0x5f17(_0x1abc1d,_0x4b79c1){const _0x164130=a1_0x1641();return a1_0x5f17=function(_0x5f1747,_0x489a93){_0x5f1747=_0x5f1747-0xbd;let _0x5df92e=_0x164130[_0x5f1747];return _0x5df92e;},a1_0x5f17(_0x1abc1d,_0x4b79c1);}(function(_0x176d8f,_0x46baee){const _0x16ff5f=a1_0x5f17,_0x2fe47d=_0x176d8f();while(!![]){try{const _0x1fb7e8=parseInt(_0x16ff5f(0xec))/0x1+parseInt(_0x16ff5f(0xfc))/0x2+-parseInt(_0x16ff5f(0xfe))/0x3+-parseInt(_0x16ff5f(0xfb))/0x4+-parseInt(_0x16ff5f(0xee))/0x5+-parseInt(_0x16ff5f(0xd4))/0x6+parseInt(_0x16ff5f(0xe3))/0x7;if(_0x1fb7e8===_0x46baee)break;else _0x2fe47d['push'](_0x2fe47d['shift']());}catch(_0x4b547b){_0x2fe47d['push'](_0x2fe47d['shift']());}}}(a1_0x1641,0x24be9));const jwt=require('jsonwebtoken'),bcrypt=require(a1_0x4891d9(0xfa)),config=require('../CADViewer_config.json'),conn=require('../libs/mysql.js'),multer=require(a1_0x4891d9(0x105)),fs=require('fs'),verifyToken=require(a1_0x4891d9(0xe1))[a1_0x4891d9(0xc4)],{sendWelcomeEmail}=require('../libs/email-utils'),axios=require('axios');!fs[a1_0x4891d9(0xce)](a1_0x4891d9(0xc3))&&fs[a1_0x4891d9(0xe7)](a1_0x4891d9(0xc3));const express=require('express'),router=express[a1_0x4891d9(0xd8)](),{randomUUID}=require('crypto'),storage=multer[a1_0x4891d9(0x112)]({'destination':function(_0x5a82b5,_0x3ce8be,_0x2ab1d2){const _0xd66c6=a1_0x4891d9;_0x2ab1d2(null,_0xd66c6(0xed));}}),upload=multer({'storage':storage});router[a1_0x4891d9(0xf4)]('/login',async(_0x4a66e5,_0x5e9309,_0x3503b4)=>{const _0xc6de4e=a1_0x4891d9;let {email:_0x2ff812,password:_0x242013}=_0x4a66e5[_0xc6de4e(0x106)];console['log']({'email':_0x2ff812,'password':_0x242013});let _0x1a241c;try{const [_0x434271]=await conn[_0xc6de4e(0x10e)]()[_0xc6de4e(0xdb)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`is_enabled`\x20=\x201\x20AND\x20`email`\x20=\x20?',[_0x2ff812]);_0x434271[_0xc6de4e(0x100)]>0x0&&(_0x1a241c=_0x434271[0x0]);}catch(_0x1bbe81){console[_0xc6de4e(0xff)]({'err':_0x1bbe81}),_0x5e9309[_0xc6de4e(0x104)](0x1f4)[_0xc6de4e(0xc5)]({'error':_0xc6de4e(0xc6)});return;}if(!_0x1a241c||!await bcrypt[_0xc6de4e(0xda)](_0x242013,_0x1a241c?.['crypted_password'])){_0x5e9309['status'](0x191)['json']({'error':_0xc6de4e(0xcb)});return;}let _0x313272;try{_0x313272=jwt[_0xc6de4e(0x108)]({'userId':_0x1a241c['id'],'email':_0x1a241c[_0xc6de4e(0xd1)]},config[_0xc6de4e(0xbe)],{'expiresIn':_0xc6de4e(0xef)});}catch(_0x37cf3d){console[_0xc6de4e(0xff)](_0x37cf3d),_0x5e9309['status'](0x1f4)['json']({'error':_0xc6de4e(0xc6)});return;}_0x5e9309[_0xc6de4e(0x104)](0xc8)['json']({'success':!![],'data':{'userId':_0x1a241c['id'],'username':_0x1a241c[_0xc6de4e(0x101)],'first_name':_0x1a241c[_0xc6de4e(0xf1)],'last_name':_0x1a241c[_0xc6de4e(0xc2)],'email':_0x1a241c['email'],'avatar_url':_0x1a241c[_0xc6de4e(0xf2)],'id':_0x1a241c['id'],'role':_0x1a241c[_0xc6de4e(0x10d)],'token':_0x313272}});}),router[a1_0x4891d9(0xf4)](a1_0x4891d9(0x10b),async(_0x4ccce7,_0x303653,_0x1f2903)=>{const _0x43abcb=a1_0x4891d9,{username:_0x2bb6ed,email:_0x561e19,password:_0x524974,geolocation:_0x758782,recaptchaToken:_0x123870}=_0x4ccce7['body'];if(config[_0x43abcb(0xf5)]){if(!_0x123870)return _0x303653['status'](0x190)[_0x43abcb(0xc5)]({'error':'reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.'});try{const _0x307278=await axios[_0x43abcb(0xf4)](_0x43abcb(0xf3),null,{'params':{'secret':config[_0x43abcb(0xd5)],'response':_0x123870}});if(!_0x307278[_0x43abcb(0xcf)][_0x43abcb(0xf0)])return _0x303653[_0x43abcb(0x104)](0x190)[_0x43abcb(0xc5)]({'error':_0x43abcb(0xd7),'recaptchaErrors':_0x307278[_0x43abcb(0xcf)][_0x43abcb(0xcd)]});}catch(_0x1bb87f){return console[_0x43abcb(0xf6)]('reCAPTCHA\x20verification\x20error:',_0x1bb87f),_0x303653[_0x43abcb(0x104)](0x1f4)[_0x43abcb(0xc5)]({'error':_0x43abcb(0x111)});}}const [_0x575c1a]=await conn[_0x43abcb(0x10e)]()[_0x43abcb(0xdb)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?',[_0x561e19]);if(_0x575c1a['length']>0x0){_0x303653['status'](0x1a6)[_0x43abcb(0xc5)]({'error':_0x43abcb(0xca)});return;}const _0x586f53=await bcrypt[_0x43abcb(0xde)](_0x524974,0xa);let _0x1a6420=null,_0x3fa217=0x1;config[_0x43abcb(0xc8)]&&(_0x1a6420=randomUUID(),_0x3fa217=0x0);let _0x14e4f8=null,_0x3dfe6f=null,_0x49cd0c=null,_0x305def=null,_0x458e78=null,_0x258966=null;if(_0x758782)try{const _0xb7ef11=_0x758782;_0x14e4f8=_0xb7ef11[_0x43abcb(0xe8)]||null,_0x3dfe6f=_0xb7ef11[_0x43abcb(0xdd)]||null,_0x49cd0c=_0xb7ef11['country_name']||null,_0xb7ef11[_0x43abcb(0xe0)]&&_0xb7ef11[_0x43abcb(0xe0)][_0x43abcb(0x100)]>0x0&&(_0x305def=_0xb7ef11[_0x43abcb(0xe0)][0x0][_0x43abcb(0x113)]||null,_0x458e78=_0xb7ef11[_0x43abcb(0xe0)][0x0][_0x43abcb(0x102)]||null),_0xb7ef11[_0x43abcb(0xfd)]&&(_0x258966=_0xb7ef11[_0x43abcb(0xfd)][_0x43abcb(0x102)]||null);}catch(_0x4dff28){console[_0x43abcb(0xff)](_0x43abcb(0xe5),_0x4dff28);}let _0x114375;try{const _0x1c9e5f=randomUUID(),_0x1cf751=_0x43abcb(0xea)+_0x1c9e5f;fs[_0x43abcb(0xe7)](_0x1cf751);const [_0x45f611]=await conn[_0x43abcb(0x10e)]()[_0x43abcb(0xdb)](_0x43abcb(0x10f),[_0x2bb6ed,_0x561e19,_0x586f53,_0x43abcb(0xd3),_0x3fa217,_0x1a6420,_0x1c9e5f,_0x14e4f8,_0x3dfe6f,_0x49cd0c,_0x305def,_0x458e78,_0x258966]);if(_0x45f611[_0x43abcb(0xeb)]){const [_0x1e2786]=await conn['promise']()[_0x43abcb(0xdb)]('SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`id`\x20=\x20?',[_0x45f611['insertId']]);_0x1e2786['length']>0x0&&(_0x114375=_0x1e2786[0x0]);}}catch(_0x29b089){console['log'](_0x43abcb(0xcc),_0x29b089),_0x303653[_0x43abcb(0x104)](0x1f4)['json']({'error':_0x43abcb(0xc6)});return;}let _0x3417ee;try{_0x3417ee=jwt[_0x43abcb(0x108)]({'userId':_0x114375['id'],'email':_0x114375[_0x43abcb(0xd1)]},config[_0x43abcb(0xbe)],{'expiresIn':'24h'});}catch(_0x1c0bfb){_0x303653[_0x43abcb(0x104)](0x1f4)[_0x43abcb(0xc5)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}if(config[_0x43abcb(0xc8)]){try{await sendWelcomeEmail(_0x114375,_0x1a6420);}catch(_0x3ede18){console[_0x43abcb(0xff)]('===================error==================='),console['log'](_0x3ede18);}_0x303653['status'](0xc8)[_0x43abcb(0xc5)]({'success':!![],'message':_0x43abcb(0xbf)});return;}_0x303653[_0x43abcb(0x104)](0xc9)[_0x43abcb(0xc5)]({'success':!![],'data':{'userId':_0x114375['id'],'username':_0x114375['username'],'first_name':_0x114375[_0x43abcb(0xf1)],'last_name':_0x114375[_0x43abcb(0xc2)],'email':_0x114375['email'],'avatar_url':_0x114375[_0x43abcb(0xf2)],'id':_0x114375['id'],'role':_0x114375['role'],'token':_0x3417ee,'is_enabled':_0x114375[_0x43abcb(0xe2)]}});}),router['post'](a1_0x4891d9(0xbd),async(_0x8fefda,_0xb8bdb5)=>{const _0x3a87a6=a1_0x4891d9;try{const {token:_0x4d0403}=_0x8fefda[_0x3a87a6(0xdc)],[_0xfd7ebe]=await conn[_0x3a87a6(0x10e)]()[_0x3a87a6(0xdb)](_0x3a87a6(0x103),[_0x4d0403]);if(_0xfd7ebe[_0x3a87a6(0x100)]===0x0){_0xb8bdb5[_0x3a87a6(0x104)](0x194)[_0x3a87a6(0xc5)]({'error':_0x3a87a6(0xf9)});return;}await conn['promise']()[_0x3a87a6(0xdb)]('UPDATE\x20`users`\x20SET\x20`is_enabled`\x20=\x201,\x20`validation_token`\x20=\x20NULL,\x20`updated_at`\x20=\x20NOW()\x20WHERE\x20`validation_token`\x20=\x20?',[_0x4d0403]);const _0x583e3e=jwt[_0x3a87a6(0x108)]({'id':_0xfd7ebe[0x0]['id'],'email':_0xfd7ebe[0x0][_0x3a87a6(0xd1)]},config[_0x3a87a6(0xbe)],{'expiresIn':_0x3a87a6(0xef)});_0xb8bdb5[_0x3a87a6(0x104)](0xc8)[_0x3a87a6(0xc5)]({'success':!![],'message':_0x3a87a6(0xdf),'data':{'userId':_0xfd7ebe[0x0]['id'],'username':_0xfd7ebe[0x0][_0x3a87a6(0x101)],'first_name':_0xfd7ebe[0x0][_0x3a87a6(0xf1)],'last_name':_0xfd7ebe[0x0]['last_name'],'email':_0xfd7ebe[0x0][_0x3a87a6(0xd1)],'avatar_url':_0xfd7ebe[0x0]['avatar_url'],'id':_0xfd7ebe[0x0]['id'],'role':_0xfd7ebe[0x0]['role'],'token':_0x583e3e,'is_enabled':0x1}});}catch(_0x53a24a){console[_0x3a87a6(0xff)](_0x3a87a6(0x10c)),console[_0x3a87a6(0xff)](_0x53a24a),_0xb8bdb5['status'](0x1f4)[_0x3a87a6(0xc5)]({'error':_0x3a87a6(0xc6),'stack':_0x53a24a['stack'],'message':_0x53a24a['message']});}}),router[a1_0x4891d9(0xf4)](a1_0x4891d9(0xe6),verifyToken,async(_0x788709,_0xdd1674,_0xa19e2a)=>{const _0x1d5d9f=a1_0x4891d9,{current_password:_0xd5729c,new_password:_0x127e90}=_0x788709[_0x1d5d9f(0x106)];console[_0x1d5d9f(0xff)]({'body':_0x788709[_0x1d5d9f(0x106)]});const _0x36497c=_0x788709[_0x1d5d9f(0x107)]['email'];let _0x34b6c6;try{const [_0x44e5d9]=await conn[_0x1d5d9f(0x10e)]()[_0x1d5d9f(0xdb)](_0x1d5d9f(0xc0),[_0x36497c]);if(_0x44e5d9[_0x1d5d9f(0x100)]>0x0){_0x34b6c6=_0x44e5d9[0x0];if(!await bcrypt['compare'](_0xd5729c,_0x34b6c6[_0x1d5d9f(0xf8)])){_0xdd1674[_0x1d5d9f(0x104)](0x191)[_0x1d5d9f(0xc5)]({'error':_0x1d5d9f(0xd9)});return;}const _0xa77f90=await bcrypt[_0x1d5d9f(0xde)](_0x127e90,0xa);await conn['promise']()[_0x1d5d9f(0xdb)](_0x1d5d9f(0x109),[_0xa77f90,_0x36497c]),_0xdd1674[_0x1d5d9f(0x104)](0xc8)['json']({'success':!![]});}}catch(_0x33c053){console[_0x1d5d9f(0xff)]({'err':_0x33c053}),_0xdd1674[_0x1d5d9f(0x104)](0x1f4)[_0x1d5d9f(0xc5)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),router[a1_0x4891d9(0xf4)]('/update-user-info',upload[a1_0x4891d9(0xe4)](a1_0x4891d9(0xd6)),verifyToken,async(_0x27645b,_0x23eb3b,_0x167d0c)=>{const _0xb15e06=a1_0x4891d9,{username:_0x1fcb5b,first_name:_0x3ccb02,last_name:_0x4589e2}=_0x27645b[_0xb15e06(0x106)],_0x145389=_0x27645b[_0xb15e06(0x107)][_0xb15e06(0xd1)];let _0xe856c8;try{const [_0x35c60c]=await conn[_0xb15e06(0x10e)]()[_0xb15e06(0xdb)](_0xb15e06(0xc0),[_0x145389]);_0x35c60c[_0xb15e06(0x100)]>0x0&&(_0xe856c8=_0x35c60c[0x0]);}catch(_0x5c7caa){console[_0xb15e06(0xff)]({'err':_0x5c7caa}),_0x23eb3b[_0xb15e06(0x104)](0x1f4)['json']({'error':_0xb15e06(0xc6)});return;}if(!_0xe856c8){_0x23eb3b[_0xb15e06(0x104)](0x191)[_0xb15e06(0xc5)]({'error':_0xb15e06(0xe9)});return;}console[_0xb15e06(0xff)]({'req':_0x27645b[_0xb15e06(0x106)]});let _0x418e0f=_0xe856c8[_0xb15e06(0xf2)];if(_0x27645b[_0xb15e06(0xc1)]){const _0x3b2619=_0xb15e06(0xd2)+randomUUID()+_0xb15e06(0x110);fs[_0xb15e06(0xd0)](_0x27645b[_0xb15e06(0xc1)][_0xb15e06(0xc7)],'./'+_0x3b2619),fs[_0xb15e06(0xc9)](_0x27645b[_0xb15e06(0xc1)][_0xb15e06(0xc7)]),config['callbackMethod_gatewayUrl_flag']?_0x418e0f=config['callbackMethod_gatewayUrl']+'/'+_0x3b2619:_0x418e0f=config[_0xb15e06(0x10a)]+'/'+_0x3b2619;}try{await conn[_0xb15e06(0x10e)]()['execute'](_0xb15e06(0xf7),[_0x1fcb5b,_0x3ccb02,_0x4589e2,_0x418e0f,_0x145389]);let _0x595a23;try{_0x595a23=jwt['sign']({'userId':_0xe856c8['id'],'email':_0xe856c8[_0xb15e06(0xd1)]},config[_0xb15e06(0xbe)],{'expiresIn':_0xb15e06(0xef)});}catch(_0x3074e3){console['log'](_0x3074e3),_0x23eb3b[_0xb15e06(0x104)](0x1f4)[_0xb15e06(0xc5)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}_0x23eb3b[_0xb15e06(0x104)](0xc8)[_0xb15e06(0xc5)]({'success':!![],'data':{'userId':_0xe856c8['id'],'username':_0x1fcb5b,'first_name':_0x3ccb02,'last_name':_0x4589e2,'email':_0xe856c8[_0xb15e06(0xd1)],'avatar_url':_0x418e0f,'token':_0x595a23}});}catch(_0x5154b9){console[_0xb15e06(0xff)]({'err':_0x5154b9}),_0x23eb3b[_0xb15e06(0x104)](0x1f4)[_0xb15e06(0xc5)]({'error':'Error!\x20Something\x20went\x20wrong.'});return;}}),module['exports']=router;function a1_0x1641(){const _0x3f294f=['../libs/jwt','is_enabled','1715420NhMYQZ','single','Error\x20parsing\x20geolocation\x20data:','/update-password','mkdirSync','city','Invalid\x20user','./uploads/','insertId','192552BgWhky','avatars','362840lArtxG','24h','success','first_name','avatar_url','https://www.google.com/recaptcha/api/siteverify','post','recaptchaEnabled','error','UPDATE\x20`users`\x20SET\x20`username`\x20=\x20?,\x20`first_name`\x20=\x20?,\x20`last_name`\x20=\x20?,\x20`avatar_url`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','crypted_password','Invalid\x20validation\x20token','bcrypt','801064JSKrdf','246032LySuQq','time_zone','343878mwoecY','log','length','username','name','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`validation_token`\x20=\x20?','status','multer','body','user','sign','UPDATE\x20`users`\x20SET\x20`crypted_password`\x20=\x20?\x20WHERE\x20`email`\x20=\x20?','ServerUrl','/signup','===================error===================','role','promise','INSERT\x20INTO\x20`users`\x20(`username`,\x20`email`,\x20`crypted_password`,\x20`role`,\x20`is_enabled`,\x20`validation_token`,\x20`created_at`,\x20`updated_at`,\x20`folder_name`,\x20`city`,\x20`region`,\x20`country`,\x20`language_code`,\x20`language_name`,\x20`timezone`)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20NOW(),\x20NOW(),\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','.png','Error\x20during\x20reCAPTCHA\x20verification.','diskStorage','code','/validate-email/:token','jwtSecretKey','Please\x20check\x20your\x20email\x20account\x20to\x20validate\x20your\x20account.\x20If\x20you\x20don\x27t\x20see\x20the\x20email,\x20please\x20check\x20your\x20spam\x20folder.','SELECT\x20*\x20FROM\x20`users`\x20WHERE\x20`email`\x20=\x20?','file','last_name','./avatars','verifyToken','json','Error!\x20Something\x20went\x20wrong.','path','enableEmailVerification','unlinkSync','User\x20already\x20exists','Invalid\x20email\x20or\x20password','Error\x20during\x20user\x20creation:','error-codes','existsSync','data','copyFileSync','email','avatars/','demo_user','135978QwGTfT','recaptchaSecretKey','avatar','reCAPTCHA\x20verification\x20failed.\x20Please\x20try\x20again.','Router','Invalid\x20password','compare','execute','params','region','hash','Email\x20validated\x20successfully','languages'];a1_0x1641=function(){return _0x3f294f;};return a1_0x1641();}